// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modèle Client - Représente un client qui peut avoir plusieurs projets
model Client {
  id       String    @id @default(cuid())
  nom      String
  email    String?   @unique
  tel      String?

  // Relations
  projets  Projet[]

  // Métadonnées
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nom])
  @@index([email])
}

// Modèle Projet - Représente un projet/chantier à une adresse donnée
model Projet {
  id        String   @id @default(cuid())
  reference String   @unique // ex: "DUPO-2024-001"

  // Relation client
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Adresse du chantier (spécifique à ce projet)
  adresse   String?  // ex: "15 Rue des Lilas"

  // Fichier PDF original
  pdfUrl        String?
  pdfOriginalNom String?

  // Relations
  menuiseries Menuiserie[]

  // Métadonnées
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([reference])
  @@index([createdAt])
}

// Modèle Menuiserie - Représente une menuiserie d'un projet
model Menuiserie {
  id        String   @id @default(cuid())

  // Relation au projet
  projetId  String
  projet    Projet   @relation(fields: [projetId], references: [id], onDelete: Cascade)

  // Identifiants
  repere    String?  // ex: "Salon", "Chambre 1"
  intitule  String   // ex: "Coulissant 2 vantaux"

  // Image de la menuiserie
  imageBase64 String? @db.Text // Image extraite du PDF en base64

  // Données flexibles stockées en JSON
  // Permet d'ajouter des champs sans migration
  donneesOriginales Json  // Données extraites du PDF
  donneesModifiees  Json? // Modifications artisan (null si pas modifié)

  // Analyse des écarts
  ecarts    Json?    // Liste des écarts calculés

  // Validation
  validee   Boolean  @default(false)
  dateValidation DateTime?

  // Ordre d'affichage
  ordre     Int      @default(0)

  // Métadonnées
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projetId])
  @@index([validee])
  @@index([ordre])
}
